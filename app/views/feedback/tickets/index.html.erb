<div class="container">
  <div class="jumbotron jumbo">
    <div class="row">
      <div class="col-7">
        <h1 class="display-4">Feedback</h1>
        <p class="lead"><strong>We support comments!</strong> Start a discussion on a ticket that is already logged
          rather than creating a new one.</p>
        <hr class="my-4">
        <small class="text-muted m-0">Open Feedback Count: <%= Feedback::Ticket.where.not(status: :closed).all.count %></small>

        <%= bootstrap_form_tag url: tickets_path, method: :get, layout: :inline, html: {data: {controller: "feedbackFilter"}} do |f| %>
          <%= f.text_field :q, hide_label: true, placeholder: 'Search by id or text', value: params[:q], "x-model" => "q", "@blur" => "reload()" %>
        <% end %>
      </div>
      <div class="col-5">
        <%= image_tag asset_url('feedback/undraw_collaborators_prrw.svg'), style: 'width: auto; max-height: 250px', class: 'float-right' %>
      </div>
    </div>
  </div>

  <div class="card position-relative">
    <div class="card-body">
      <div class="row">
        <div class="col-md-2">
          <div x-data="filterValues()" class="position-relative">
            <%= bootstrap_form_tag url: tickets_path, method: :get do |f| %>
              <%= f.select :status, options_for_select(Feedback::Ticket.statuses.keys.map { |k| [k.humanize, k] }, params[:status]), {prompt: 'status'}, {class: 'select-initial-height', "x-model" => "status", "@change" => "reload()"} %>
              <%= f.select :priority, options_for_select(Feedback::Ticket.priorities.keys.map { |k| [k.humanize, k] }, params[:priority]), {prompt: 'priority'}, {class: 'select-initial-height', "x-model" => "priority", "@change" => "reload()"} %>
              <%= f.select :category, options_for_select(Feedback::Ticket.categories.keys.map { |k| [k.humanize, k] }, params[:category]), {prompt: 'category'}, {class: 'select-initial-height', "x-model" => "category", "@change" => "reload()"} %>
              <%= f.select :assignee, options_for_select(User.where(id: Feedback::Ticket.all.distinct(:owner).pluck(:owner_id)).map { |u| [u.name, u.id] }, params[:assignee]), {prompt: 'assignee'}, {class: 'select-initial-height', "x-model" => "assignee", "@change" => "reload()"} %>
              <%= f.select :requester, options_for_select(User.where(id: Feedback::Ticket.all.distinct(:user).pluck(:user_id)).map { |u| [u.name, u.id] }, params[:requester]), {prompt: 'requester'}, {class: 'select-initial-height', "x-model" => "requester", "@change" => "reload()"} %>
              <%= f.select :order, options_for_select(['priority', 'created_at', 'ice_score'], params[:order]), {prompt: 'sort'}, {class: 'select-initial-height', "x-model" => "order", "@change" => "reload()"} %>
              <%= link_to 'Clear Filters', tickets_path(@ticket), class: "btn btn-primary" %>
            <% end %>
            <script>
                function filterValues() {
                    var urlParams = new URLSearchParams(window.location.search);
                    return {
                        status: urlParams.get('status') || '',
                        priority: urlParams.get('priority') || '',
                        category: urlParams.get('category') || '',
                        assignee: urlParams.get('assignee') || '',
                        requester: urlParams.get('requester') || '',
                        order: urlParams.get('order') || '',
                        q: urlParams.get('q') || '',
                        reload: function () {
                            var params = [];
                            if (this.status != "") {
                                params.push('status=' + this.status)
                            }
                            if (this.category != "") {
                                params.push('category=' + this.category)
                            }
                            if (this.priority != "") {
                                params.push('priority=' + this.priority)
                            }
                            if (this.assignee != "") {
                                params.push('assignee=' + this.assignee)
                            }
                            if (this.requester != "") {
                                params.push('requester=' + this.requester)
                            }
                            if (this.q != "") {
                                params.push('q=' + this.q)
                            }
                            if (this.order != "") {
                                params.push('order=' + this.order)
                            }
                            location.href = '?' + params.join('&')
                        }
                    }
                }
            </script>
          </div>
        </div>
        <div class="col-md-10">
          <%= link_to new_ticket_path, class: "float-right" do %>
            <i class="fas fa-plus-circle h3"  data-container="body" data-toggle="popover" data-placement="top" data-content="Create a new feedback ticket!"></i>
          <% end %>
          <p class="text-muted mb-4">Showing <%= @tickets.count %> results.</p>
          <% if @tickets.empty? %>
            <h3>These aren't the droids you're looking for...</h3>
            <p class="text-muted">There are no feedback tickets matching your results</p>
          <% end %>
          <% @tickets.order("created_at DESC").each do |ticket| %>
            <%= link_to ticket_path(ticket), style: "text-decoration: none;", class: "list-group-item list-group-item-action flex-column align-items-start" do %>
              <div class="row">
                <div class="col-md-1 text-center">
                  <small class="text-muted">#<%= ticket.id %></small>
                  <%= render partial: 'state', locals: {ticket: ticket} %>
                </div>
                <div class="col-md-9">
                  <div class="row">
                    <p class="text-muted mb-0"><%= ticket.user %></p>
                  </div>
                  <div class="row">
                    <h6><%= strip_tags(ticket.text.to_s).truncate(128) %></h6>
                  </div>
                  <div class="row">
                    <p class="text-muted">
                      <%= time_ago_in_words(ticket.created_at) %> ago :
                      <%= ticket.comments.count %> comments.
                    </p>
                  </div>
                </div>
                <div class="col-md-2 text-center align-middle text-primary">
                    <h3 class="m-0">
                      <i class="fas fa-user-circle <%= 'text-muted' if ticket.owner.nil? %>"></i>
                    </h3>
                    <small class="text-muted"><%= ticket.owner.present? ? ticket.owner : 'No one' %> assigned.</small>
                </div>
              </div>
            <% end %>
          <% end %>
          <div class="row justify-content-center mt-4">
            <%== pagy_bootstrap_nav(@pagy) %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>